name: Vector Nayan V44 ‚Äì Full Cycle CSV Generator

on:
  workflow_dispatch:
  push:
    paths:
      - run_config.json

jobs:
  blackbox-run:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    # ----------------------------------------------------
    # 1Ô∏è‚É£ CHECKOUT RUN CONFIG REPO
    # ----------------------------------------------------
    - name: Checkout run configuration
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2Ô∏è‚É£ VALIDATE TOKEN (FAIL FAST)
    # ----------------------------------------------------
    - name: Validate Kernal_TOKEN
      env:
        TOKEN: ${{ secrets.Kernal_TOKEN }}
      run: |
        if [ -z "$TOKEN" ]; then
          echo "‚ùå Kernal_TOKEN secret not found"
          exit 1
        else
          echo "‚úÖ Kernal_TOKEN detected"
        fi

    # ----------------------------------------------------
    # 3Ô∏è‚É£ CLONE PRIVATE VECTOR NAYAN KERNEL
    # ----------------------------------------------------
    - name: Clone Vector Nayan V44 Kernel
      run: |
        git clone https://${{ secrets.Kernal_TOKEN }}@github.com/nayan9572/VECTOR_NAYAN_V44_KERNAL.git kernel

    # ----------------------------------------------------
    # 4Ô∏è‚É£ INJECT run_config.json INTO KERNEL
    # ----------------------------------------------------
    - name: Inject run_config.json
      run: |
        cp run_config.json kernel/run_config.json
        ls -l kernel/run_config.json

    # ----------------------------------------------------
    # 5Ô∏è‚É£ SETUP PYTHON (STABLE)
    # ----------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    # ----------------------------------------------------
    # 6Ô∏è‚É£ INSTALL ALL REQUIRED LIBRARIES (CI SAFE)
    # ----------------------------------------------------
    - name: Install Python dependencies (FULL ‚Äì CI SAFE)
      run: |
        python -m pip install --upgrade pip

        pip install \
          numpy \
          pandas \
          scipy \
          matplotlib \
          networkx \
          seaborn \
          scikit-learn \
          tqdm \
          ipython \
          notebook

    # ----------------------------------------------------
    # 7Ô∏è‚É£ CREATE GOOGLE.COLAB STUB (PREVENT IMPORT ERROR)
    # ----------------------------------------------------
    - name: Create google.colab stub (CI safe)
      run: |
        mkdir -p google
        cat <<EOF > google/__init__.py
        EOF
        cat <<EOF > google/colab.py
        class files:
            @staticmethod
            def download(x):
                print("CI mode: download skipped", x)
        EOF

    # ----------------------------------------------------
    # 8Ô∏è‚É£ FORCE NON-GUI MATPLOTLIB BACKEND
    # ----------------------------------------------------
    - name: Configure matplotlib backend
      run: |
        export MPLBACKEND=Agg

    # ----------------------------------------------------
    # 9Ô∏è‚É£ RUN VECTOR NAYAN V44 KERNEL
    # ----------------------------------------------------
    - name: Run Vector Nayan V44 Kernel
      working-directory: kernel
      run: |
        python main_runner.py

    # ----------------------------------------------------
    # üîü UPLOAD CSV OUTPUTS
    # ----------------------------------------------------
    - name: Upload CSV outputs
      uses: actions/upload-artifact@v4
      with:
        name: Vector_Nayan_V44_CSV_Output
        path: |
          kernel/**/*.csv

    # ----------------------------------------------------
    # 1Ô∏è‚É£1Ô∏è‚É£ UPLOAD GENERATED PLOTS (IF ANY)
    # ----------------------------------------------------
    - name: Upload plots
      uses: actions/upload-artifact@v4
      with:
        name: Vector_Nayan_V44_Plots
        path: |
          kernel/**/*.png
