name: Vector Nayan V44 ‚Äî FULL KERNEL CI (AUTHORITATIVE)

on:
  workflow_dispatch:
  push:
    paths:
      - run_config.json
      - kernel/**

jobs:
  v44-full-run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    # ==================================================
    # 1Ô∏è‚É£ CHECKOUT CONTROLLER REPO
    # ==================================================
    - name: Checkout controller repo
      uses: actions/checkout@v4

    # ==================================================
    # 2Ô∏è‚É£ VALIDATE TOKEN (FAIL FAST)
    # ==================================================
    - name: Validate Kernal_TOKEN
      run: |
        if [ -z "${{ secrets.Kernal_TOKEN }}" ]; then
          echo "‚ùå Kernal_TOKEN missing"
          exit 1
        fi
        echo "‚úÖ Kernal_TOKEN OK"

    # ==================================================
    # 3Ô∏è‚É£ CLONE PRIVATE KERNEL (ONLY SOURCE OF TRUTH)
    # ==================================================
    - name: Clone Vector Nayan V44 Kernel
      run: |
        rm -rf kernel
        git clone \
          https://x-access-token:${{ secrets.Kernal_TOKEN }}@github.com/nayan9572/VECTOR_NAYAN_V44_KERNAL.git \
          kernel
        echo "‚úÖ Kernel cloned"
        ls kernel

    # ==================================================
    # 4Ô∏è‚É£ INJECT RUN CONFIG
    # ==================================================
    - name: Inject run_config.json
      run: |
        cp run_config.json kernel/run_config.json
        echo "üì¶ run_config.json injected"
        cat kernel/run_config.json

    # ==================================================
    # 5Ô∏è‚É£ PYTHON SETUP
    # ==================================================
    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    # ==================================================
    # 6Ô∏è‚É£ INSTALL ALL REQUIRED LIBRARIES (EXPLICIT)
    # ==================================================
    - name: Install Python dependencies (FULL)
      run: |
        python -m pip install --upgrade pip
        pip install \
          numpy \
          pandas \
          scipy \
          matplotlib \
          networkx \
          seaborn \
          scikit-learn \
          tqdm

    # ==================================================
    # 7Ô∏è‚É£ CI-SAFE GOOGLE COLAB STUB
    # ==================================================
    - name: Stub google.colab (CI SAFE)
      run: |
        mkdir -p kernel/google/colab
        echo "def download(x): print('CI MODE: download skipped')" > kernel/google/colab/files.py
        touch kernel/google/__init__.py
        touch kernel/google/colab/__init__.py
        echo "‚úÖ google.colab stubbed"

    # ==================================================
    # 8Ô∏è‚É£ FORCE NON-GUI BACKEND
    # ==================================================
    - name: Force matplotlib Agg backend
      run: |
        export MPLBACKEND=Agg
        echo "‚úÖ matplotlib backend set to Agg"

    # ==================================================
    # 9Ô∏è‚É£ HARD SANITY CHECK (FIXED)
    # ==================================================
    - name: Kernel sanity check
      run: |
        echo "üìÇ Kernel contents:"
        ls kernel
        echo "üîé Runner check:"
        test -f kernel/main_runner.py || (echo "‚ùå main_runner.py missing" && exit 1)
        echo "‚úÖ main_runner.py found"

    # ==================================================
    # üîü RUN THE ONLY AUTHORITATIVE ENTRY POINT
    # ==================================================
    - name: Run Vector Nayan V44 (AUTHORITATIVE)
      working-directory: kernel 
      run: |
        echo "üöÄ VECTOR NAYAN V44 ‚Äî CI RUN START"
        python main_runner.py
        echo "üèÅ VECTOR NAYAN V44 ‚Äî CI RUN END"

    # ==================================================
    # 1Ô∏è‚É£1Ô∏è‚É£ VERIFY CSV (STRICT)
    # ==================================================
    - name: Verify CSV output
      run: |
        echo "üìÑ CSV files:"
        ls kernel/*.csv || (echo "‚ùå CSV NOT FOUND" && exit 1)

    # ==================================================
    # 1Ô∏è‚É£2Ô∏è‚É£ UPLOAD CSV ARTIFACT
    # ==================================================
    - name: Upload CSV Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Vector_Nayan_V44_Final_CSV
        path: kernel/*.csv

    - name: Upload Influence Graph
      uses: actions/upload-artifact@v4
      with:
       name: Dynamic-Influence-Jungle
       path: kernel/dynamic_influence_jungle.png
