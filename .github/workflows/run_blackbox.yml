name: Vector Nayan V44 ‚Äì Full Kernel CI Run

on:
  workflow_dispatch:
  push:
    paths:
      - run_config.json
      - kernel/**

jobs:
  v44-kernel-run:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------
    # 1Ô∏è‚É£ Checkout THIS repo (run_config + workflow)
    # --------------------------------------------------
    - name: Checkout run-config repo
      uses: actions/checkout@v4

    # --------------------------------------------------
    # 2Ô∏è‚É£ Validate Kernel Token (early fail)
    # --------------------------------------------------
    - name: Validate Kernel_TOKEN
      run: |
        if [ -z "${{ secrets.Kernal_TOKEN }}" ]; then
          echo "‚ùå Kernal_TOKEN secret missing"
          exit 1
        else
          echo "‚úÖ Kernal_TOKEN found"
        fi

    # --------------------------------------------------
    # 3Ô∏è‚É£ Clone PRIVATE Vector Nayan Kernel
    # --------------------------------------------------
    - name: Clone Vector Nayan V44 Kernel
      run: |
        git clone https://x-access-token:${{ secrets.Kernal_TOKEN }}@github.com/nayan9572/VECTOR_NAYAN_V44_KERNAL.git kernel

    # --------------------------------------------------
    # 4Ô∏è‚É£ Inject run_config.json INTO kernel folder
    # --------------------------------------------------
    - name: Inject run_config.json
      run: |
        cp run_config.json kernel/run_config.json
        echo "üì¶ run_config.json injected"

    # --------------------------------------------------
    # 5Ô∏è‚É£ Setup Python
    # --------------------------------------------------
    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    # --------------------------------------------------
    # 6Ô∏è‚É£ Install ALL REQUIRED LIBRARIES (CI SAFE)
    # --------------------------------------------------
    - name: Install Python dependencies (FULL ‚Äì CI SAFE)
      run: |
        python -m pip install --upgrade pip
        pip install \
          numpy \
          pandas \
          scipy \
          matplotlib \
          networkx \
          seaborn \
          scikit-learn \
          tqdm

    # --------------------------------------------------
    # 7Ô∏è‚É£ CI SAFE stub for google.colab (NO ERROR)
    # --------------------------------------------------
    - name: Create google.colab stub (CI safe)
      run: |
        mkdir -p google/colab
        echo "def download(x): print('CI MODE: download skipped')" > google/colab/files.py
        touch google/__init__.py
        touch google/colab/__init__.py

    # --------------------------------------------------
    # 8Ô∏è‚É£ Force matplotlib to NON-GUI backend
    # --------------------------------------------------
    - name: Configure matplotlib backend
      run: |
        echo "import matplotlib; matplotlib.use('Agg')" > mpl_fix.py

    # --------------------------------------------------
    # 9Ô∏è‚É£ Run Vector Nayan V44 Kernel
    # --------------------------------------------------
    - name: Run Vector Nayan V44 Kernel
      working-directory: kernel
      run: |
        echo "===== VECTOR NAYAN V44 CI RUN START ====="
        python main_runner.py
        echo "===== VECTOR NAYAN V44 CI RUN END ====="

    # --------------------------------------------------
    # üîü Verify CSV existence (HARD CHECK)
    # --------------------------------------------------
    - name: Verify CSV existence
      run: |
        if ls kernel/*.csv 1> /dev/null 2>&1; then
          echo "‚úÖ CSV files found"
          ls kernel/*.csv
        else
          echo "‚ùå No CSV files generated"
          exit 1
        fi

    # --------------------------------------------------
    # 1Ô∏è‚É£1Ô∏è‚É£ Upload CSV as GitHub Artifact
    # --------------------------------------------------
    - name: Upload CSV outputs
      uses: actions/upload-artifact@v4
      with:
        name: Vector_Nayan_V44_CSV_Output
        path: kernel/*.csv
